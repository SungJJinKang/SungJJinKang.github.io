---
layout: post
title:  "안드로이드 Tombstone에서 함수의 이름을 찾는법?"
date:   2022-09-21
tags: [ComputerScience]
---         

이슈 진행 중 안드로이드 기기에서 가져온 Tombstone에서 콜스택 중 우리 프로젝트쪽 함수 이름이 드러나 있었다.       
엥... 분명 디버그 심볼을 전부 strip 했는데 어떻게 우리 프로젝트의 함수명을 찾았지... 궁금했다. 소스 코드 파일명과 소스 코드에서의 line은 드러나지 않았지만, 함수명이 보이는 것이 혹여나 보안상 문제가 될지 않을까 걱정했다.....               
              
일단 결론만 말하면 export한 함수, 변수들이 있는 shared library의 심볼 테이블에서 함수명을 찾은거였다.           
Backtrace를 하면서 스택 프레임의 스택 영역의 데이터를 워드 사이즈 단위로 읽다 보면 함수 호출시 남기는 return 주소를 찾을 수 있고, 이 주소를 해당 library에서의 상대적 주소로 바꾼 후 심볼 테이블을 전부 뒤져서 해당 return 주소를 포함하는 함수의 이름, entry 주소를 찾은 것이었다.        
           
[Tombstone의 dump_stack_segment에서 특정 스택 프레임을 워드 사이즈 단위로 전부 읽어서 해당 값의 함수명을 가져온다. 해당 값이 주소인 경우 그리고 text section에 속한 경우 함수명을 찾을 수 있다.](https://android.googlesource.com/platform/system/core/+/81df1cc77722000f8d0025c1ab00ced123aa573c/debuggerd/tombstone.cpp) ->                    
[Backtrace::GetFunctionName](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libbacktrace/Backtrace.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=56?gsn=GetFunctionName&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2Finclude%2Fbacktrace%2FBacktrace.h%23YQizb7vhc39wC1jZRRtUiC6A75-PnsSRIt5G9Cpmo1w&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2FBacktrace.cpp%23m70atAoBBaZItLgEveGBoXRYx4zknr9qpxTkNsRGvZ8) ->                    
[UnwindStackCurrent::GetFunctionNameRaw](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libbacktrace/UnwindStack.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=166?gsn=GetFunctionNameRaw&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2FUnwindStack.cpp%23SEgmWmFBfmEd12BW8SWd4QPL4kTTu7cv8XCLpFpL47g&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2FUnwindStack.h%23GPLqW855L-MuGM82sqFYAozFoywQ2scz9RsrRVbsAl8) ->                  
[UnwindStackMap::GetFunctionName](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libbacktrace/UnwindStackMap.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=119?gsn=GetFunctionName&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2FUnwindStackMap.cpp%23IHDJmomTKr57CDj2fpkmsnQzkS7H82qDtFfHRttz7JM&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibbacktrace%2FUnwindStackMap.h%237IFwfa88uHaxMN01yT6v5tKSNz4ty9cV7m1CTDHIpFM) ->                   
[매핑된 Library 상에서의 주소의 상대적 주소를 Elf에서 가져온 후, Elf::GetFunctionName 호출](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libunwindstack/Elf.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=113?gsn=GetFunctionName&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2Finclude%2Funwindstack%2FElf.h%23A0BiqKrXpWVw1KO7QRHMT-heEeje7qSqD6CfYrMAfKs&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FElf.cpp%236iEVFQGDMsea-gAEHqdcWVj7m9pagT2oep7th_Nru64) ->                      
[Elf에 있는 섹션 헤더를 전부 읽어 심볼 테이블을 찾음, ElfInterfaceImpl::ReadSectionHeaders, SHT_SYMTAB, SHT_DYNSYM](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libunwindstack/ElfInterface.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=273?gsn=ReadSectionHeaders&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2Finclude%2Funwindstack%2FElfInterface.h%238OxDbLZeUBGDJkyvMBhH1ySdahyYYGy4d5n17ypkmXw&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FElfInterface.cpp%233DTp_TjsQN1OTDheFEiJaDsUmCM-XMdfje7B2oIoDqI) ->                         
[ElfInterfaceImpl::GetFunctionName 함수명을 찾기 위해 상대적 명령어 주소를 가지고 심볼을 순회함](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libunwindstack/ElfInterface.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=420?gsn=GetFunctionName&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2Finclude%2Funwindstack%2FElfInterface.h%231yRYwlZX122KMhDWYGlC424_To6FALxxlxwr-6zVdZo&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FElfInterface.cpp%23mqgFKwc5iVhvsA6a-Jy1Zc7OHgsiU7gauvsPZrDjrpY) ->                
 [Symbols::GetName에서 Binary 탐색으로 심볼 테이블에서 알맞은 심볼을 찾음](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libunwindstack/Symbols.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=126?gsn=GetName&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FSymbols.cpp%233GUWaeC62I8mgxFd4CqtP1bnUWJwq124uom9auGc0n8&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FSymbols.h%23TZmRkBVQhSF-SBAZywoJGUP2EWyf-uj5PQL75bMXboE&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FSymbols.cpp%235sxcKEsiBmXDrDygLAsBkO9yPD6LsX3SMBEhQMfFpvM) ->                              
 [Symbols::BinarySearch](https://cs.android.com/android/platform/superproject/+/master:system/unwinding/libunwindstack/Symbols.cpp;drc=6c0463c65694ffbfd298a3eaa7324c396383625f;bpv=1;bpt=1;l=50?gsn=BinarySearch&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FSymbols.cpp%23XMubs35m0iQyjetyTZSBnoONnNdxhwG8nwaf2Cs-U30&gs=kythe%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fsuperproject%3Flang%3Dc%252B%252B%3Fpath%3Dsystem%2Funwinding%2Flibunwindstack%2FSymbols.h%23bFoGbwC-ES_9SQUAsHUJbriR2Egnr0tq-jgYKo4kP4s)              
